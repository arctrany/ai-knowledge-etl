# Knowledge ETL ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬ï¼š0.1.3
> æ—¥æœŸï¼š2025-12-15
> çŠ¶æ€ï¼šå·²å®ç°

## â›” å…³é”®é…ç½®ï¼šé˜²æ­¢ "Prompt is too long"

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸš¨ MCP é…ç½®å¿…é¡»åŒ…å« --image-responses omit ğŸš¨                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘  é»˜è®¤æƒ…å†µä¸‹ï¼Œbrowser_take_screenshot ä¼šå°†å›¾ç‰‡åµŒå…¥åˆ°å¯¹è¯ä¸Šä¸‹æ–‡ä¸­ï¼Œ         â•‘
â•‘  è¿™ä¼šå¯¼è‡´ "Prompt is too long" é”™è¯¯ã€‚                                     â•‘
â•‘                                                                           â•‘
â•‘  è§£å†³æ–¹æ¡ˆï¼šåœ¨ .mcp.json ä¸­é…ç½® --image-responses omit                     â•‘
â•‘                                                                           â•‘
â•‘  é…ç½®ç¤ºä¾‹ (.mcp.json):                                                    â•‘
â•‘  {                                                                        â•‘
â•‘    "playwright": {                                                        â•‘
â•‘      "command": "npx",                                                    â•‘
â•‘      "args": [                                                            â•‘
â•‘        "-y", "@playwright/mcp@latest",                                   â•‘
â•‘        "--user-data-dir", "~/.playwright-mcp",                           â•‘
â•‘        "--image-responses", "omit",        â† å…³é”®é…ç½®ï¼                   â•‘
â•‘        "--viewport-size", "1280,720"                                      â•‘
â•‘      ]                                                                    â•‘
â•‘    }                                                                      â•‘
â•‘  }                                                                        â•‘
â•‘                                                                           â•‘
â•‘  æ•ˆæœï¼šæˆªå›¾åªä¿å­˜åˆ°æ–‡ä»¶ï¼Œä¸åµŒå…¥ä¸Šä¸‹æ–‡ï¼Œç”±å­ä»£ç†è¯»å–å¤„ç†                   â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## é‡è¦æ¶æ„å†³ç­–

### MCP å·¥å…·éš”ç¦»æ€§

**å‘ç°**: MCP å·¥å…·ï¼ˆå¦‚ Playwrightï¼‰ä¸ä¼šè‡ªåŠ¨ä¼ æ’­åˆ°å­ä»£ç†ï¼ˆsubagentï¼‰ã€‚

**å½±å“**:
- å­ä»£ç†ï¼ˆextractor agentï¼‰æ— æ³•ç›´æ¥ä½¿ç”¨ `mcp__playwright__*` å·¥å…·
- å³ä½¿åœ¨ agent é…ç½®ä¸­å£°æ˜äº†è¿™äº›å·¥å…·ï¼Œå­ä»£ç†ä¹Ÿæ— æ³•è®¿é—®

**è§£å†³æ–¹æ¡ˆ**:
1. **ä¸»ä¸Šä¸‹æ–‡å¤„ç† URL æå–**: ä½¿ç”¨ Playwright è·å–é¡µé¢å†…å®¹å¹¶ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
2. **ä¸»ä¸Šä¸‹æ–‡æå–å¹¶ä¸‹è½½å›¾ç‰‡**: ä½¿ç”¨ browser_evaluate è·å–å›¾ç‰‡URLï¼Œcurl ä¸‹è½½ï¼ˆv3.0 æ–°å¢ï¼‰
3. **å­ä»£ç†å¤„ç†æœ¬åœ°æ–‡ä»¶**: è¯»å–ä¿å­˜çš„æ–‡ä»¶ï¼ˆå¿«ç…§ã€æˆªå›¾ã€å·²ä¸‹è½½å›¾ç‰‡ï¼‰è¿›è¡Œå†…å®¹å¤„ç†
4. **åˆ†å·¥æ˜ç¡®**: ä¸»ä¸Šä¸‹æ–‡ = ç½‘ç»œäº¤äº’ + å›¾ç‰‡ä¸‹è½½ï¼Œå­ä»£ç† = å†…å®¹å¤„ç†ï¼ˆéš”ç¦»ä¸Šä¸‹æ–‡é˜²æº¢å‡ºï¼‰

### ç½‘é¡µå›¾ç‰‡æå–æ¶æ„ (v3.0 æ–°å¢)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç½‘é¡µå›¾ç‰‡æå–æµç¨‹ (3-Phase)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  PHASE 1: ä¸»ä¸Šä¸‹æ–‡ - é¡µé¢æ•è· + å›¾ç‰‡ä¸‹è½½                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚  1. browser_navigate â†’ åŠ è½½é¡µé¢                                          â”‚
â”‚  2. browser_press_key("End") â†’ è§¦å‘æ‡’åŠ è½½                               â”‚
â”‚  3. browser_snapshot â†’ ä¿å­˜æ–‡æœ¬å¿«ç…§                                      â”‚
â”‚  4. browser_evaluate â†’ æå–å›¾ç‰‡URL (è¿‡æ»¤è£…é¥°å›¾)                          â”‚
â”‚  5. browser_evaluate â†’ è·å–cookies                                       â”‚
â”‚  6. curl + cookies â†’ å¹¶è¡Œä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°                                  â”‚
â”‚  7. compress-image.sh â†’ å‹ç¼©å¤§å›¾ç‰‡ (<300KB)                              â”‚
â”‚                                                                          â”‚
â”‚  è¾“å‡ºæ–‡ä»¶:                                                               â”‚
â”‚  â”œâ”€â”€ .playwright-mcp/snapshot.md     (æ–‡æœ¬å¿«ç…§)                          â”‚
â”‚  â”œâ”€â”€ .playwright-mcp/screenshot.png  (æ•´é¡µæˆªå›¾ï¼Œå¤‡ç”¨)                    â”‚
â”‚  â”œâ”€â”€ .playwright-mcp/images.json     (å›¾ç‰‡å…ƒæ•°æ®)                        â”‚
â”‚  â””â”€â”€ .playwright-mcp/img_*.jpg       (å·²ä¸‹è½½å¹¶å‹ç¼©çš„å›¾ç‰‡)                â”‚
â”‚                                                                          â”‚
â”‚  PHASE 2: å­ä»£ç† - å†…å®¹å¤„ç†                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚  1. è¯»å– snapshot.md (åˆ†å—å¤„ç†å¤§æ–‡ä»¶)                                    â”‚
â”‚  2. è¯»å– images.json (å›¾ç‰‡å…ƒæ•°æ®)                                        â”‚
â”‚  3. é€ä¸ªè¯»å– img_*.jpgï¼Œç”Ÿæˆæ–‡å­—æè¿°                                     â”‚
â”‚  4. ç»„åˆæ–‡æœ¬ + å›¾ç‰‡æè¿° â†’ çº¯ Markdown                                    â”‚
â”‚                                                                          â”‚
â”‚  å…³é”®çº¦æŸ:                                                               â”‚
â”‚  â”œâ”€â”€ æ¯æ¬¡åªè¯»å–ä¸€å¼ å›¾ç‰‡ (é˜²æ­¢ä¸Šä¸‹æ–‡æº¢å‡º)                                 â”‚
â”‚  â”œâ”€â”€ è¯»å–åç«‹å³æè¿°å¹¶é‡Šæ”¾                                                â”‚
â”‚  â””â”€â”€ æœ€å¤šå¤„ç†5å¼ å›¾ç‰‡                                                     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å›¾ç‰‡ç­›é€‰è§„åˆ™**:
- å°ºå¯¸ â‰¥ 100x100 åƒç´ 
- è·³è¿‡: icon, logo, avatar, emoji, button, arrow, loading ç­‰è£…é¥°å›¾
- æœ€å¤šä¸‹è½½5å¼ å›¾ç‰‡
- å•å¼ æœ€å¤§5MBï¼Œä¸‹è½½åå‹ç¼©åˆ° <300KB

### å·²çŸ¥é™åˆ¶ (v3.0.1)

**é’‰é’‰æ–‡æ¡£å›¾ç‰‡è®¤è¯é—®é¢˜**:
- é’‰é’‰æ–‡æ¡£ (alidocs.dingtalk.com) çš„å›¾ç‰‡APIä½¿ç”¨å¤æ‚è®¤è¯æœºåˆ¶
- ä»…ä¼ é€’ document.cookie ä¸è¶³ä»¥è·å–å›¾ç‰‡å†…å®¹
- å½“å‰è¡Œä¸ºï¼šæå–å›¾ç‰‡å…ƒæ•°æ®ï¼ˆå°ºå¯¸ã€altæ–‡æœ¬ã€URLï¼‰ï¼Œä½†æ— æ³•ä¸‹è½½å®é™…å›¾ç‰‡å†…å®¹
- é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ images.json ä¸­çš„å…ƒæ•°æ®ç”Ÿæˆå ä½æè¿°

**è§£å†³æ–¹æ¡ˆ** (ä¿®æ­£æ–¹æ¡ˆ):

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  â›” é‡è¦æ›´æ–°: ç¦æ­¢åœ¨ä¸»ä¸Šä¸‹æ–‡ä½¿ç”¨ browser_take_screenshot â›”              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘  browser_take_screenshot ä¼šå°†å›¾ç‰‡åµŒå…¥å¯¹è¯ä¸Šä¸‹æ–‡ï¼                        â•‘
â•‘  å³ä½¿åªæˆªå–ä¸€å¼ å›¾ç‰‡ï¼Œä¹Ÿå¯èƒ½å¯¼è‡´ "Prompt is too long" é”™è¯¯                â•‘
â•‘                                                                           â•‘
â•‘  âŒ å·²åºŸå¼ƒ: ç‚¹å‡»æµ®å±‚åå¾ªç¯æˆªå›¾æ–¹æ¡ˆ                                       â•‘
â•‘  âœ… æ­£ç¡®åšæ³•: browser_evaluate æå– URL + curl ä¸‹è½½                      â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**æ¨èæ–¹æ¡ˆ: browser_evaluate + curl ä¸‹è½½**
```
1. browser_evaluate æå–é¡µé¢ä¸­å›¾ç‰‡çš„ src URL
2. ä¿å­˜åˆ° images.json
3. ä½¿ç”¨ curl æ‰¹é‡ä¸‹è½½å›¾ç‰‡ï¼ˆé›¶ä¸Šä¸‹æ–‡å½±å“ï¼‰
4. å­ä»£ç†å¤„ç†æœ¬åœ°å›¾ç‰‡æ–‡ä»¶ï¼ˆéš”ç¦»ä¸Šä¸‹æ–‡ï¼‰

ä»£ç æµç¨‹ï¼š
# Step 1: æå–å›¾ç‰‡ URL
browser_evaluate({
  function: "() => Array.from(document.querySelectorAll('img'))
    .slice(0, 5)
    .map((img, i) => ({index: i, src: img.src, alt: img.alt}))"
})
â†’ å†™å…¥ images.json

# Step 2: curl ä¸‹è½½ï¼ˆæ— ä¸Šä¸‹æ–‡å½±å“ï¼‰
for img in images.json:
  curl -o "img_{index}.jpg" "{src}"

# Step 3: å­ä»£ç†å¤„ç†
Task(subagent: "extractor", prompt: "å¤„ç†æœ¬åœ°å›¾ç‰‡...")
```

**ä¼˜åŠ¿**:
- é›¶ä¸Šä¸‹æ–‡å¢é•¿
- å¯å¤„ç†ä»»æ„æ•°é‡å›¾ç‰‡
- ä¸ä¼šè§¦å‘ "Prompt is too long"

**é™çº§é€‰é¡¹**:
- å¦‚æœå›¾ç‰‡éœ€è¦è®¤è¯æ— æ³•ä¸‹è½½ï¼Œä½¿ç”¨ images.json å…ƒæ•°æ®ç”Ÿæˆæ–‡å­—æè¿°å ä½

### Transform é˜¶æ®µé˜²æº¢å‡ºæœºåˆ¶

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ›¡ï¸ åˆ†å±‚æ‘˜è¦æ¶æ„ - é˜²æ­¢ Transform é˜¶æ®µæº¢å‡º                                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘  é—®é¢˜ï¼šçˆ¬å–20+é¡µé¢å¯äº§ç”Ÿ400KB+å†…å®¹ï¼ŒTransform è¯»å–å…¨éƒ¨ â†’ æº¢å‡ºï¼           â•‘
â•‘                                                                           â•‘
â•‘  è§£å†³æ–¹æ¡ˆï¼šå››å±‚é˜²æŠ¤                                                       â•‘
â•‘                                                                           â•‘
â•‘  Layer 1: é…ç½®å±‚ (config/limits.yaml)                                    â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â•‘
â•‘  transform:                                                               â•‘
â•‘    max_input_chars: 30000           # ç›´æ¥è¯»å–ä¸Šé™                       â•‘
â•‘    max_input_chars_hard: 50000      # ç»å¯¹ä¸Šé™                           â•‘
â•‘    summary_per_page_chars: 500      # æ¯é¡µæ‘˜è¦é™åˆ¶                       â•‘
â•‘    use_index_only_threshold: 10     # >10é¡µåªè¯» INDEX.md                 â•‘
â•‘    generate_summary_threshold: 5    # >5é¡µå…ˆç”Ÿæˆæ‘˜è¦                     â•‘
â•‘                                                                           â•‘
â•‘  Layer 2: æå–å±‚ (extractor.md)                                          â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â•‘
â•‘  æ¯é¡µæå–æ—¶åŒæ—¶ç”Ÿæˆ .summary æ–‡ä»¶ï¼š                                       â•‘
â•‘    pages/001_doc.md        # å®Œæ•´å†…å®¹                                    â•‘
â•‘    pages/001_doc.summary   # 500å­—ç¬¦æ‘˜è¦                                 â•‘
â•‘                                                                           â•‘
â•‘  Layer 3: æ±‡æ€»å±‚ (crawler-summarizer.md)                                 â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â•‘
â•‘  ä¼˜å…ˆè¯»å– .summary æ–‡ä»¶ï¼ˆä¿è¯å®‰å…¨ï¼‰ï¼š                                     â•‘
â•‘    1. æ£€æŸ¥ .summary æ–‡ä»¶ â†’ è¯»å–ï¼ˆmax 500 chars eachï¼‰                   â•‘
â•‘    2. æ— æ‘˜è¦ â†’ åªè¯» frontmatterï¼ˆå‰20è¡Œï¼‰                                â•‘
â•‘    3. åªå¯¹ top 3 é«˜ç›¸å…³é¡µè¯»å–å®Œæ•´å†…å®¹                                    â•‘
â•‘                                                                           â•‘
â•‘  Layer 4: è½¬æ¢å±‚ (output-transformer.md)                                 â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                â•‘
â•‘  å¼ºåˆ¶é¢„æ£€ï¼Œä¸‰çº§ç­–ç•¥ï¼š                                                     â•‘
â•‘                                                                           â•‘
â•‘    é¡µæ•° â‰¤5 ä¸” <30K  â†’ direct         è¯»å– REPORT.md      ~30K chars      â•‘
â•‘    é¡µæ•° 6-10 æˆ– >30K â†’ summarize_first å…ˆæ‘˜è¦å†è½¬æ¢      ~15K chars      â•‘
â•‘    é¡µæ•° >10          â†’ index_only    åªè¯» INDEX.md       ~5K chars       â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**æ•°æ®æµï¼š**
```
Crawler                  Extractor                 Summarizer              Transformer
   â”‚                         â”‚                         â”‚                        â”‚
   â”‚ æ•è· URL                â”‚                         â”‚                        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚                         â”‚                        â”‚
   â”‚                         â”‚ æå–å†…å®¹                â”‚                        â”‚
   â”‚                         â”‚ ç”Ÿæˆ .md + .summary     â”‚                        â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚                        â”‚
   â”‚                         â”‚                         â”‚ è¯»å– .summary          â”‚
   â”‚                         â”‚                         â”‚ ç”Ÿæˆ REPORT.md         â”‚
   â”‚                         â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
   â”‚                         â”‚                         â”‚                        â”‚ é¢„æ£€å¤§å°
   â”‚                         â”‚                         â”‚                        â”‚ é€‰æ‹©ç­–ç•¥
   â”‚                         â”‚                         â”‚                        â”‚ è¾“å‡ºç»“æœ
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å·¥å…·å¯ç”¨æ€§æ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   ä¸»ä¸Šä¸‹æ–‡ (Main Context)                                                â”‚
â”‚   â”œâ”€â”€ æ ‡å‡†å·¥å…·: Read, Write, Bash, Glob, Grep...                        â”‚
â”‚   â”œâ”€â”€ MCP å·¥å…·: mcp__playwright__*, mcp__deepwiki__*...                â”‚
â”‚   â””â”€â”€ å¯è°ƒç”¨å­ä»£ç†                                                       â”‚
â”‚                                                                          â”‚
â”‚   å­ä»£ç† (Subagent via Task)                                             â”‚
â”‚   â”œâ”€â”€ æ ‡å‡†å·¥å…·: Read, Write, Bash, Glob, Grep...                        â”‚
â”‚   â””â”€â”€ âŒ MCP å·¥å…·ä¸å¯ç”¨                                                  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 å®šä½

Knowledge ETL æ˜¯ä¸€ä¸ª**å†…å®¹æå–ä¸ç†è§£**çš„åŸå­èƒ½åŠ›å±‚ï¼Œä¸º Claude æä¾›ä»äº’è”ç½‘ã€æ–‡ä»¶ç³»ç»Ÿã€æ–‡æ¡£ä¸­ç³»ç»ŸåŒ–è·å–å’Œç†è§£å†…å®¹çš„èƒ½åŠ›ã€‚

### 1.2 æ ¸å¿ƒçº¦æŸ

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸš¨ğŸš¨ğŸš¨ IRON RULE: PREVENT "PROMPT IS TOO LONG" AT ALL COSTS ğŸš¨ğŸš¨ğŸš¨      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                           â•‘
â•‘  "Prompt is too long" error = COMPLETE PLUGIN FAILURE                    â•‘
â•‘  This is UNACCEPTABLE and must be prevented with 100% certainty.         â•‘
â•‘                                                                           â•‘
â•‘  âŒ ç¦æ­¢è§¦å‘ "Prompt Too Long" é”™è¯¯ - è¿™æ˜¯æ’ä»¶çš„ç»å¯¹æ­»åˆ‘              â•‘
â•‘  âŒ ç¦æ­¢åœ¨ä¸»ä¸Šä¸‹æ–‡è¯»å–å¤§æ–‡ä»¶ï¼ˆå¿«ç…§ã€æˆªå›¾ã€é¡µé¢å†…å®¹ï¼‰                  â•‘
â•‘  âŒ ç¦æ­¢ä½¿ç”¨ Read() è€Œä¸å…ˆæ£€æŸ¥æ–‡ä»¶å¤§å°                                â•‘
â•‘  âŒ ç¦æ­¢é˜»å¡ç”¨æˆ·ï¼ˆé‡éšœç¢å¿…é¡»äº¤äº’ï¼‰                                    â•‘
â•‘  âŒ ç¦æ­¢ä¸¢å¤±å…³é”®ä¿¡æ¯ï¼ˆæ— å£°å¤±è´¥ï¼‰                                      â•‘
â•‘                                                                           â•‘
â•‘  âœ… æ‰€æœ‰å†…å®¹å¤„ç†å¿…é¡»åœ¨éš”ç¦»çš„å­ä»£ç†ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ                        â•‘
â•‘  âœ… ä¸»ä¸Šä¸‹æ–‡åªåšï¼šPlaywright æŠ“å–ã€Bash æ£€æŸ¥ã€Task åˆ†å‘               â•‘
â•‘  âœ… è¯»å–å‰å¿…é¡»ç”¨ wc -l æˆ– stat æ£€æŸ¥æ–‡ä»¶å¤§å°                           â•‘
â•‘  âœ… å¤§æ–‡ä»¶ï¼ˆ>500è¡Œï¼‰å¿…é¡»åˆ†å—è¯»å–ï¼šRead(limit: 500)                    â•‘
â•‘  âœ… å›¾ç‰‡å¿…é¡»å‹ç¼©åˆ° <300KB æ‰èƒ½è¯»å–                                    â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 1.3 æ ¸å¿ƒèƒ½åŠ›

| èƒ½åŠ› | æè¿° |
|------|------|
| **å®‰å…¨æå–** | ä»»æ„å¤§å°çš„è¾“å…¥éƒ½èƒ½å®‰å…¨å¤„ç†ï¼Œç»ä¸è¶…é™ |
| **éšœç¢åº”å¯¹** | ç™»å½•ã€åçˆ¬ã€æƒé™é—®é¢˜é€šè¿‡ç”¨æˆ·äº¤äº’è§£å†³ |
| **ç»“æ„ç†è§£** | ä¿ç•™æ–‡æ¡£ç»“æ„ï¼Œå›¾ç‰‡è½¬æ–‡å­—æè¿° |
| **æ ¼å¼è¾“å‡º** | è¾“å‡ºæ ¼å¼åŒ– Markdown æˆ–ç»“æ„åŒ– JSON |
| **ç»„ä»¶ç”Ÿæˆ** | å¯é€‰è°ƒç”¨ plugin-dev ç”Ÿæˆ Skill/Plugin |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Knowledge ETL Pipeline                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   ç”¨æˆ·è¾“å…¥                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  /knowledge-etl:extract <source> [options]                      â”‚   â”‚
â”‚   â”‚                                                                  â”‚   â”‚
â”‚   â”‚  source: URL | æ–‡ä»¶è·¯å¾„ | Glob æ¨¡å¼ | ç›®å½•è·¯å¾„                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Layer 1: è¾“å…¥è§£æå±‚                           â”‚   â”‚
â”‚   â”‚                    (Input Parser)                                â”‚   â”‚
â”‚   â”‚                                                                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚   â”‚   â”‚   URL    â”‚  â”‚  æ–‡ä»¶    â”‚  â”‚  Glob    â”‚  â”‚  ç›®å½•    â”‚       â”‚   â”‚
â”‚   â”‚   â”‚ Detector â”‚  â”‚ Detector â”‚  â”‚ Expander â”‚  â”‚ Scanner  â”‚       â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚   â”‚                              â”‚                                   â”‚   â”‚
â”‚   â”‚                              â–¼                                   â”‚   â”‚
â”‚   â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚   â”‚                    â”‚   ä»»åŠ¡é˜Ÿåˆ—ç”Ÿæˆ    â”‚                         â”‚   â”‚
â”‚   â”‚                    â”‚   TaskQueue[]    â”‚                         â”‚   â”‚
â”‚   â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Layer 2: å®‰å…¨æ§åˆ¶å±‚                           â”‚   â”‚
â”‚   â”‚                    (Safety Controller)                           â”‚   â”‚
â”‚   â”‚                                                                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                    é¢„æ£€æ¨¡å—                               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  æ–‡ä»¶å¤§å°æ£€æŸ¥ â”€â”€â†’ è¶…é™? â”€â”€â†’ å‹ç¼©/åˆ†å—ç­–ç•¥               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  ç´¯è®¡å¤§å°æ£€æŸ¥ â”€â”€â†’ è¶…é™? â”€â”€â†’ åˆ†æ‰¹å¤„ç†ç­–ç•¥               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  æ–‡ä»¶æ•°é‡æ£€æŸ¥ â”€â”€â†’ è¿‡å¤š? â”€â”€â†’ æ‘˜è¦æ¨¡å¼ç­–ç•¥               â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                              â”‚                                   â”‚   â”‚
â”‚   â”‚                              â–¼                                   â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                    å¤„ç†ç­–ç•¥åˆ†é…                           â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  Task + Strategy = ExecutionPlan                        â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  ç­–ç•¥ç±»å‹ï¼š                                              â”‚  â”‚   â”‚
â”‚   â”‚   â”‚    - DIRECT: ç›´æ¥å¤„ç†ï¼ˆå°æ–‡ä»¶ï¼‰                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚    - COMPRESS: å‹ç¼©åå¤„ç†ï¼ˆå¤§å›¾ç‰‡ï¼‰                      â”‚  â”‚   â”‚
â”‚   â”‚   â”‚    - CHUNK: åˆ†å—å¤„ç†ï¼ˆé•¿æ–‡æ¡£/é•¿é¡µé¢ï¼‰                    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚    - SUMMARY: æ‘˜è¦æ¨¡å¼ï¼ˆè¶…å¤§å†…å®¹ï¼‰                       â”‚  â”‚   â”‚
â”‚   â”‚   â”‚    - SCREENSHOT: æˆªå›¾æ¨¡å¼ï¼ˆåŠ¨æ€é¡µé¢ï¼‰                    â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Layer 3: æå–æ‰§è¡Œå±‚                           â”‚   â”‚
â”‚   â”‚                    (Extraction Engine)                           â”‚   â”‚
â”‚   â”‚                                                                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                    éšœç¢æ£€æµ‹ä¸å¤„ç†                         â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”‚ ç™»å½•    â”‚  â”‚ åçˆ¬    â”‚  â”‚ æƒé™    â”‚  â”‚ è¶…æ—¶    â”‚    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”‚ æ‹¦æˆª    â”‚  â”‚ æ£€æµ‹    â”‚  â”‚ ä¸è¶³    â”‚  â”‚ å¤±è´¥    â”‚    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                          â”‚                               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                          â–¼                               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚              â”‚    ç”¨æˆ·äº¤äº’è¯·æ±‚     â”‚                    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚              â”‚  AskUserQuestion   â”‚                    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                              â”‚                                   â”‚   â”‚
â”‚   â”‚                              â–¼                                   â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                    å†…å®¹æå–å™¨                             â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”‚   Web   â”‚  â”‚  Image  â”‚  â”‚   PDF   â”‚  â”‚  Text   â”‚    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”‚Extractorâ”‚  â”‚Extractorâ”‚  â”‚Extractorâ”‚  â”‚Extractorâ”‚    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  æ¯ä¸ªæå–å™¨åœ¨ç‹¬ç«‹ Agent ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ                     â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  æå–å®Œæˆåç«‹å³é‡Šæ”¾ä¸Šä¸‹æ–‡                                 â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Layer 4: ç†è§£ä¸è½¬æ¢å±‚                         â”‚   â”‚
â”‚   â”‚                    (Understanding Engine)                        â”‚   â”‚
â”‚   â”‚                                                                  â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                    ç»“æ„åŒ–ç†è§£                             â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  åŸå§‹å†…å®¹ â”€â”€â†’ ç»“æ„è§£æ â”€â”€â†’ ä¸­é—´è¡¨ç¤º (IR)                â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  IR = {                                                  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚    meta: { source, title, type, extractedAt },          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚    structure: [ sections... ],                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚    content: [ paragraphs, lists, tables... ],           â”‚  â”‚   â”‚
â”‚   â”‚   â”‚    assets: [ { type, description, extractedText }... ]  â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  }                                                       â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                              â”‚                                   â”‚   â”‚
â”‚   â”‚                              â–¼                                   â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚   â”‚                    å›¾ç‰‡ç†è§£                               â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  å›¾ç‰‡ç±»å‹è¯†åˆ« â”€â”€â†’ ä¸“ç”¨æè¿°ç­–ç•¥                           â”‚  â”‚   â”‚
â”‚   â”‚   â”‚                                                          â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”‚ æµç¨‹å›¾  â”‚  â”‚ æ¶æ„å›¾  â”‚  â”‚ æˆªå›¾    â”‚  â”‚ å›¾è¡¨    â”‚    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”‚         â”‚  â”‚         â”‚  â”‚         â”‚  â”‚         â”‚    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â”‚èŠ‚ç‚¹+æµå‘â”‚  â”‚å±‚çº§+ç»„ä»¶â”‚  â”‚å¸ƒå±€+æ–‡å­—â”‚  â”‚æ•°æ®+è¶‹åŠ¿â”‚    â”‚  â”‚   â”‚
â”‚   â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Layer 5: è¾“å‡ºç”Ÿæˆå±‚                           â”‚   â”‚
â”‚   â”‚                    (Output Generator)                            â”‚   â”‚
â”‚   â”‚                                                                  â”‚   â”‚
â”‚   â”‚   IR â”€â”€â†’ è¾“å‡ºæ ¼å¼é€‰æ‹©                                           â”‚   â”‚
â”‚   â”‚              â”‚                                                   â”‚   â”‚
â”‚   â”‚              â”œâ”€â”€â†’ Markdown â”€â”€â†’ æ ¼å¼åŒ–æ–‡æ¡£                       â”‚   â”‚
â”‚   â”‚              â”‚                                                   â”‚   â”‚
â”‚   â”‚              â”œâ”€â”€â†’ JSON â”€â”€â†’ ç»“æ„åŒ–æ•°æ®                           â”‚   â”‚
â”‚   â”‚              â”‚                                                   â”‚   â”‚
â”‚   â”‚              â””â”€â”€â†’ Skill/Plugin â”€â”€â†’ è°ƒç”¨ plugin-dev              â”‚   â”‚
â”‚   â”‚                                                                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®æµ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   è¾“å…¥                å¤„ç†                  å­˜å‚¨              è¾“å‡º       â”‚
â”‚                                                                          â”‚
â”‚   URL â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚            â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   æ–‡ä»¶ â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â†’â”‚  ä»»åŠ¡é˜Ÿåˆ—   â”‚â”€â”€â”€â”€â”€â†’â”‚  ä¸´æ—¶å­˜å‚¨   â”‚                 â”‚
â”‚            â”‚      â”‚  TaskQueue  â”‚      â”‚  /tmp/etl/  â”‚                 â”‚
â”‚   ç›®å½• â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                          â”‚                    â”‚                         â”‚
â”‚                          â–¼                    â”‚                         â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                         â”‚
â”‚                   â”‚  æ‰§è¡Œè®¡åˆ’   â”‚             â”‚                         â”‚
â”‚                   â”‚  ExecPlan   â”‚             â”‚                         â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚                         â”‚
â”‚                          â”‚                    â”‚                         â”‚
â”‚                          â–¼                    â”‚                         â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                         â”‚
â”‚            â”‚     æ‰¹æ¬¡å¤„ç†å¾ªç¯        â”‚        â”‚                         â”‚
â”‚            â”‚                         â”‚        â”‚                         â”‚
â”‚            â”‚  for batch in batches:  â”‚        â”‚                         â”‚
â”‚            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚                         â”‚
â”‚            â”‚    â”‚ Agent Context   â”‚  â”‚        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚            â”‚    â”‚  (éš”ç¦»)         â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â†’â”‚   æ‘˜è¦æ–‡ä»¶   â”‚    â”‚
â”‚            â”‚    â”‚                 â”‚  â”‚        â”‚     â”‚  .summary   â”‚    â”‚
â”‚            â”‚    â”‚ æå– â†’ ç†è§£     â”‚  â”‚        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚    â”‚      â†’ æ‘˜è¦     â”‚  â”‚        â”‚                         â”‚
â”‚            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚                         â”‚
â”‚            â”‚           â†“             â”‚        â”‚                         â”‚
â”‚            â”‚    é‡Šæ”¾ä¸Šä¸‹æ–‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                         â”‚
â”‚            â”‚                         â”‚        â”‚                         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚                         â”‚
â”‚                          â”‚                    â”‚                         â”‚
â”‚                          â–¼                    â”‚                         â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                         â”‚
â”‚                   â”‚  æ±‡æ€»é˜¶æ®µ   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                   â”‚             â”‚                                       â”‚
â”‚                   â”‚ è¯»å–æ‰€æœ‰æ‘˜è¦â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                   â”‚ ç”Ÿæˆæœ€ç»ˆIR â”‚â”€â”€â”€â”€â”€â†’â”‚        æœ€ç»ˆè¾“å‡º              â”‚ â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚                             â”‚ â”‚
â”‚                                        â”‚  - formatted.md (Markdown)  â”‚ â”‚
â”‚                                        â”‚  - structured.json (JSON)   â”‚ â”‚
â”‚                                        â”‚  - skill.md (Skill)         â”‚ â”‚
â”‚                                        â”‚  - plugin/ (Plugin)         â”‚ â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.1 è¾“å…¥è§£æå±‚ (Input Parser)

#### 3.1.1 èŒè´£

- è¯†åˆ«è¾“å…¥ç±»å‹ï¼ˆURL/æ–‡ä»¶/Glob/ç›®å½•ï¼‰
- å±•å¼€ Glob å’Œç›®å½•ä¸ºæ–‡ä»¶åˆ—è¡¨
- ç”Ÿæˆæ ‡å‡†åŒ–çš„ä»»åŠ¡é˜Ÿåˆ—

#### 3.1.2 è¾“å…¥ç±»å‹æ£€æµ‹

```typescript
interface InputSource {
  raw: string;              // åŸå§‹è¾“å…¥
  type: 'url' | 'file' | 'glob' | 'directory';
  resolved: string[];       // è§£æåçš„å…·ä½“è·¯å¾„/URL åˆ—è¡¨
}

function detectInputType(input: string): InputSource {
  if (input.startsWith('http://') || input.startsWith('https://')) {
    return { raw: input, type: 'url', resolved: [input] };
  }

  if (input.includes('*') || input.includes('?')) {
    return { raw: input, type: 'glob', resolved: globExpand(input) };
  }

  if (isDirectory(input)) {
    return { raw: input, type: 'directory', resolved: scanDirectory(input) };
  }

  return { raw: input, type: 'file', resolved: [input] };
}
```

#### 3.1.3 ç›®å½•æ‰«æè§„åˆ™

```yaml
# é»˜è®¤æ’é™¤è§„åˆ™
exclude:
  directories:
    - node_modules
    - .git
    - .svn
    - __pycache__
    - .cache
    - dist
    - build

  files:
    - "*.lock"
    - "*.log"
    - ".DS_Store"
    - "Thumbs.db"

  patterns:
    - ".*"        # éšè—æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

# æ”¯æŒçš„æ–‡ä»¶ç±»å‹
include:
  documents:
    - "*.md"
    - "*.txt"
    - "*.pdf"
    - "*.doc"
    - "*.docx"

  images:
    - "*.png"
    - "*.jpg"
    - "*.jpeg"
    - "*.gif"
    - "*.webp"
    - "*.svg"

  data:
    - "*.json"
    - "*.yaml"
    - "*.yml"
    - "*.xml"

  code:  # å¯é€‰ï¼Œç”¨äºä»£ç æ–‡æ¡£
    - "*.ts"
    - "*.js"
    - "*.py"
```

#### 3.1.4 ä»»åŠ¡é˜Ÿåˆ—ç»“æ„

```typescript
interface Task {
  id: string;               // å”¯ä¸€æ ‡è¯†
  source: string;           // æ¥æºè·¯å¾„æˆ– URL
  type: 'url' | 'image' | 'pdf' | 'markdown' | 'text' | 'json';
  size?: number;            // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  priority: number;         // å¤„ç†ä¼˜å…ˆçº§ï¼ˆå°æ–‡ä»¶ä¼˜å…ˆï¼‰
  dependencies?: string[];  // ä¾èµ–çš„å…¶ä»–ä»»åŠ¡ï¼ˆå¦‚ md å¼•ç”¨çš„å›¾ç‰‡ï¼‰
  status: 'pending' | 'processing' | 'completed' | 'failed' | 'skipped';
}

interface TaskQueue {
  tasks: Task[];
  totalSize: number;
  estimatedBatches: number;
}
```

---

### 3.2 å®‰å…¨æ§åˆ¶å±‚ (Safety Controller)

#### 3.2.1 èŒè´£

- é¢„æ£€æ‰€æœ‰ä»»åŠ¡ï¼Œè¯„ä¼°é£é™©
- åˆ†é…å¤„ç†ç­–ç•¥
- æ§åˆ¶æ‰¹æ¬¡å¤§å°
- ç¡®ä¿ç»ä¸è¶…é™

#### 3.2.2 å®‰å…¨é˜ˆå€¼

```typescript
const SAFETY_LIMITS = {
  // === å•æ–‡ä»¶é™åˆ¶ ===
  image: {
    maxSize: 300 * 1024,        // 300KBï¼ˆå‹ç¼©åï¼‰
    maxWidth: 800,               // 800px
    maxHeight: 4000,             // 4000pxï¼ˆé•¿å›¾é™åˆ¶ï¼‰
  },

  pdf: {
    maxPages: 20,                // æœ€å¤šå¤„ç† 20 é¡µ
    maxSizePerPage: 100 * 1024,  // æ¯é¡µæ‘˜è¦é™ 100KB
  },

  text: {
    maxChars: 50000,             // å•æ–‡æœ¬æœ€å¤§ 5 ä¸‡å­—ç¬¦
    chunkSize: 10000,            // åˆ†å—å¤§å° 1 ä¸‡å­—ç¬¦
  },

  url: {
    maxSnapshotChars: 40000,     // å¿«ç…§æœ€å¤§ 4 ä¸‡å­—ç¬¦
    maxScreenshotSegments: 5,    // æœ€å¤š 5 ä¸ªæ»šåŠ¨æˆªå›¾
  },

  // === æ‰¹æ¬¡é™åˆ¶ ===
  batch: {
    maxFiles: 5,                 // å•æ‰¹æ¬¡æœ€å¤š 5 ä¸ªæ–‡ä»¶
    maxTotalSize: 1 * 1024 * 1024, // å•æ‰¹æ¬¡æœ€å¤§ 1MB
    maxImages: 3,                // å•æ‰¹æ¬¡æœ€å¤š 3 å¼ å›¾
  },

  // === è¾“å‡ºé™åˆ¶ ===
  output: {
    summaryMaxChars: 500,        // å•æ–‡ä»¶æ‘˜è¦ä¸Šé™
    totalMaxChars: 100000,       // æœ€ç»ˆè¾“å‡ºä¸Šé™ 10 ä¸‡å­—ç¬¦
  },

  // === ä¼šè¯é™åˆ¶ ===
  session: {
    maxTasks: 100,               // å•æ¬¡æœ€å¤šå¤„ç† 100 ä¸ªä»»åŠ¡
    maxTotalSize: 50 * 1024 * 1024, // å•æ¬¡æœ€å¤§åŸå§‹å¤§å° 50MB
  },
};
```

#### 3.2.3 å¤„ç†ç­–ç•¥

```typescript
type ProcessingStrategy =
  | 'DIRECT'      // ç›´æ¥å¤„ç†ï¼ˆå°æ–‡ä»¶ï¼Œæ— éœ€é¢„å¤„ç†ï¼‰
  | 'COMPRESS'    // å‹ç¼©å¤„ç†ï¼ˆå¤§å›¾ç‰‡ï¼‰
  | 'CHUNK'       // åˆ†å—å¤„ç†ï¼ˆé•¿æ–‡æœ¬/é•¿é¡µé¢ï¼‰
  | 'SUMMARY'     // ä»…æ‘˜è¦ï¼ˆè¶…å¤§å†…å®¹ï¼‰
  | 'SCREENSHOT'  // æˆªå›¾æ¨¡å¼ï¼ˆåŠ¨æ€é¡µé¢/åçˆ¬ï¼‰
  | 'SKIP'        // è·³è¿‡ï¼ˆä¸æ”¯æŒçš„ç±»å‹ï¼‰
  | 'REJECT';     // æ‹’ç»ï¼ˆè¶…å‡ºèƒ½åŠ›èŒƒå›´ï¼‰

interface ExecutionPlan {
  task: Task;
  strategy: ProcessingStrategy;
  params: {
    compressTo?: number;       // å‹ç¼©ç›®æ ‡å¤§å°
    chunkCount?: number;       // åˆ†å—æ•°é‡
    summaryOnly?: boolean;     // ä»…ç”Ÿæˆæ‘˜è¦
    screenshotSegments?: number; // æˆªå›¾æ®µæ•°
  };
  estimatedOutputSize: number; // é¢„ä¼°è¾“å‡ºå¤§å°
}

function assignStrategy(task: Task): ExecutionPlan {
  const { type, size } = task;

  // å›¾ç‰‡ç­–ç•¥
  if (type === 'image') {
    if (size <= SAFETY_LIMITS.image.maxSize) {
      return { task, strategy: 'DIRECT', params: {}, estimatedOutputSize: 500 };
    }
    return {
      task,
      strategy: 'COMPRESS',
      params: { compressTo: SAFETY_LIMITS.image.maxSize },
      estimatedOutputSize: 500,
    };
  }

  // PDF ç­–ç•¥
  if (type === 'pdf') {
    const pages = estimatePdfPages(task.source);
    if (pages > SAFETY_LIMITS.pdf.maxPages) {
      return {
        task,
        strategy: 'SUMMARY',
        params: { summaryOnly: true },
        estimatedOutputSize: 1000,
      };
    }
    return { task, strategy: 'DIRECT', params: {}, estimatedOutputSize: pages * 500 };
  }

  // æ–‡æœ¬ç­–ç•¥
  if (type === 'markdown' || type === 'text') {
    if (size > SAFETY_LIMITS.text.maxChars) {
      const chunks = Math.ceil(size / SAFETY_LIMITS.text.chunkSize);
      return {
        task,
        strategy: 'CHUNK',
        params: { chunkCount: chunks },
        estimatedOutputSize: Math.min(size, SAFETY_LIMITS.output.totalMaxChars),
      };
    }
    return { task, strategy: 'DIRECT', params: {}, estimatedOutputSize: size };
  }

  // URL ç­–ç•¥
  if (type === 'url') {
    return {
      task,
      strategy: 'DIRECT',  // å…ˆå°è¯•ç›´æ¥æå–ï¼Œå¤±è´¥åé™çº§
      params: {},
      estimatedOutputSize: 5000,
    };
  }

  return { task, strategy: 'SKIP', params: {}, estimatedOutputSize: 0 };
}
```

#### 3.2.4 æ‰¹æ¬¡è§„åˆ’

```typescript
interface Batch {
  id: number;
  plans: ExecutionPlan[];
  totalEstimatedSize: number;
}

function planBatches(plans: ExecutionPlan[]): Batch[] {
  const batches: Batch[] = [];
  let currentBatch: Batch = { id: 0, plans: [], totalEstimatedSize: 0 };

  // æŒ‰ä¼˜å…ˆçº§æ’åºï¼ˆå°æ–‡ä»¶ä¼˜å…ˆï¼‰
  const sorted = plans.sort((a, b) => a.estimatedOutputSize - b.estimatedOutputSize);

  for (const plan of sorted) {
    const wouldExceed =
      currentBatch.plans.length >= SAFETY_LIMITS.batch.maxFiles ||
      currentBatch.totalEstimatedSize + plan.estimatedOutputSize > SAFETY_LIMITS.batch.maxTotalSize ||
      countImages(currentBatch) >= SAFETY_LIMITS.batch.maxImages && plan.task.type === 'image';

    if (wouldExceed && currentBatch.plans.length > 0) {
      batches.push(currentBatch);
      currentBatch = { id: batches.length, plans: [], totalEstimatedSize: 0 };
    }

    currentBatch.plans.push(plan);
    currentBatch.totalEstimatedSize += plan.estimatedOutputSize;
  }

  if (currentBatch.plans.length > 0) {
    batches.push(currentBatch);
  }

  return batches;
}
```

---

### 3.3 æå–æ‰§è¡Œå±‚ (Extraction Engine)

#### 3.3.1 èŒè´£

- æ£€æµ‹å¹¶å¤„ç†æå–éšœç¢
- æ‰§è¡Œå…·ä½“çš„æå–æ“ä½œ
- åœ¨éš”ç¦»çš„ Agent ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ
- è¿”å›æ ‡å‡†åŒ–çš„æå–ç»“æœ

#### 3.3.2 éšœç¢æ£€æµ‹ä¸å¤„ç†

```typescript
type Obstacle =
  | 'LOGIN_REQUIRED'    // éœ€è¦ç™»å½•
  | 'CAPTCHA'           // éªŒè¯ç 
  | 'ANTI_SCRAPE'       // åçˆ¬æ£€æµ‹
  | 'PERMISSION_DENIED' // æƒé™ä¸è¶³
  | 'NOT_FOUND'         // èµ„æºä¸å­˜åœ¨
  | 'TIMEOUT'           // è¶…æ—¶
  | 'NETWORK_ERROR'     // ç½‘ç»œé”™è¯¯
  | 'UNSUPPORTED_FORMAT'; // ä¸æ”¯æŒçš„æ ¼å¼

interface ObstacleDetection {
  detected: boolean;
  type?: Obstacle;
  message?: string;
  recoverable: boolean;
  suggestedAction?: 'login' | 'screenshot' | 'retry' | 'skip' | 'abort';
}

// éšœç¢æ£€æµ‹è§„åˆ™
const OBSTACLE_PATTERNS = {
  LOGIN_REQUIRED: [
    /ç™»å½•|login|sign.?in|unauthorized|è¯·å…ˆç™»å½•/i,
    /401|403/,
  ],
  CAPTCHA: [
    /éªŒè¯ç |captcha|verify|äººæœºéªŒè¯/i,
  ],
  ANTI_SCRAPE: [
    /cloudflare|checking.+browser|è¯·ç¨å€™/i,
    /access.+denied|blocked/i,
  ],
};

function detectObstacle(content: string, statusCode?: number): ObstacleDetection {
  // æ£€æŸ¥ç©ºå†…å®¹
  if (!content || content.trim().length < 100) {
    return {
      detected: true,
      type: 'ANTI_SCRAPE',
      message: 'é¡µé¢å†…å®¹ä¸ºç©ºæˆ–è¿‡å°‘ï¼Œå¯èƒ½è¢«åçˆ¬æ‹¦æˆª',
      recoverable: true,
      suggestedAction: 'screenshot',
    };
  }

  // æ£€æŸ¥ç™»å½•
  for (const pattern of OBSTACLE_PATTERNS.LOGIN_REQUIRED) {
    if (pattern.test(content)) {
      return {
        detected: true,
        type: 'LOGIN_REQUIRED',
        message: 'é¡µé¢éœ€è¦ç™»å½•',
        recoverable: true,
        suggestedAction: 'login',
      };
    }
  }

  // æ£€æŸ¥éªŒè¯ç 
  for (const pattern of OBSTACLE_PATTERNS.CAPTCHA) {
    if (pattern.test(content)) {
      return {
        detected: true,
        type: 'CAPTCHA',
        message: 'éœ€è¦å®ŒæˆéªŒè¯ç ',
        recoverable: true,
        suggestedAction: 'login',
      };
    }
  }

  return { detected: false, recoverable: true };
}
```

#### 3.3.3 ç”¨æˆ·äº¤äº’å¤„ç†

```typescript
interface UserInteraction {
  type: 'question' | 'wait' | 'confirm';
  title: string;
  message: string;
  options?: Array<{
    label: string;
    value: string;
    description?: string;
  }>;
  timeout?: number;  // ç­‰å¾…è¶…æ—¶ï¼ˆç§’ï¼‰
}

// é¢„å®šä¹‰çš„äº¤äº’åœºæ™¯
const INTERACTIONS = {
  loginRequired: (url: string): UserInteraction => ({
    type: 'wait',
    title: 'éœ€è¦ç™»å½•',
    message: `é¡µé¢ ${url} éœ€è¦ç™»å½•ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­å®Œæˆç™»å½•åç»§ç»­`,
    options: [
      { label: 'å·²å®Œæˆç™»å½•', value: 'continue', description: 'ç»§ç»­æå–' },
      { label: 'è·³è¿‡æ­¤é¡µ', value: 'skip', description: 'è·³è¿‡è¿™ä¸ªé¡µé¢' },
      { label: 'å–æ¶ˆæå–', value: 'abort', description: 'å–æ¶ˆæ•´ä¸ªæå–ä»»åŠ¡' },
    ],
    timeout: 300,  // 5 åˆ†é’Ÿè¶…æ—¶
  }),

  useScreenshot: (url: string): UserInteraction => ({
    type: 'confirm',
    title: 'åˆ‡æ¢åˆ°æˆªå›¾æ¨¡å¼',
    message: `é¡µé¢ ${url} æ— æ³•ç›´æ¥æå–ï¼Œæ˜¯å¦ä½¿ç”¨æˆªå›¾æ¨¡å¼ï¼Ÿ`,
    options: [
      { label: 'ä½¿ç”¨æˆªå›¾', value: 'screenshot', description: 'æ»šåŠ¨æˆªå›¾å¹¶åˆ†æ' },
      { label: 'è·³è¿‡æ­¤é¡µ', value: 'skip', description: 'è·³è¿‡è¿™ä¸ªé¡µé¢' },
    ],
  }),

  largeContent: (details: string): UserInteraction => ({
    type: 'confirm',
    title: 'å†…å®¹è¾ƒå¤§',
    message: details,
    options: [
      { label: 'ç»§ç»­å¤„ç†', value: 'continue', description: 'å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´' },
      { label: 'ä»…æå–æ‘˜è¦', value: 'summary', description: 'åªç”Ÿæˆå†…å®¹æ‘˜è¦' },
      { label: 'å–æ¶ˆ', value: 'abort', description: 'å–æ¶ˆæ­¤ä»»åŠ¡' },
    ],
  }),

  manyFiles: (count: number, batches: number): UserInteraction => ({
    type: 'confirm',
    title: 'æ–‡ä»¶æ•°é‡è¾ƒå¤š',
    message: `å‘ç° ${count} ä¸ªæ–‡ä»¶ï¼Œå°†åˆ† ${batches} æ‰¹å¤„ç†ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`,
    options: [
      { label: 'å…¨éƒ¨å¤„ç†', value: 'all', description: `å¤„ç†å…¨éƒ¨ ${count} ä¸ªæ–‡ä»¶` },
      { label: 'åªå¤„ç†å‰ 20 ä¸ª', value: 'partial', description: 'åªå¤„ç†å‰ 20 ä¸ªæ–‡ä»¶' },
      { label: 'å–æ¶ˆ', value: 'abort', description: 'å–æ¶ˆæ­¤ä»»åŠ¡' },
    ],
  }),
};
```

#### 3.3.4 æå–å™¨å®ç°

```typescript
// æå–ç»“æœæ¥å£
interface ExtractionResult {
  success: boolean;
  source: string;
  type: 'url' | 'image' | 'pdf' | 'text';
  content?: {
    title?: string;
    text: string;           // æå–çš„æ–‡æœ¬
    structure?: string[];   // æ–‡æ¡£ç»“æ„ï¼ˆæ ‡é¢˜åˆ—è¡¨ï¼‰
    images?: ImageDescription[];
    tables?: TableData[];
  };
  error?: {
    type: Obstacle | 'UNKNOWN';
    message: string;
  };
  stats: {
    originalSize: number;
    extractedChars: number;
    imagesProcessed: number;
    processingTimeMs: number;
  };
}

interface ImageDescription {
  index: number;
  label: string;
  category: 'flowchart' | 'architecture' | 'screenshot' | 'chart' | 'photo' | 'other';
  description: string;      // è§†è§‰æè¿°
  extractedText?: string;   // å›¾ä¸­æ–‡å­—
}

// Web æå–å™¨
async function extractWeb(url: string, strategy: ProcessingStrategy): Promise<ExtractionResult> {
  const startTime = Date.now();

  // 1. å¯¼èˆªåˆ°é¡µé¢
  await playwright.navigate(url);
  await playwright.waitFor({ time: 3 });

  // 2. å°è¯•å¿«ç…§æå–
  const snapshot = await playwright.snapshot();

  // 3. æ£€æŸ¥éšœç¢
  const obstacle = detectObstacle(snapshot);
  if (obstacle.detected) {
    if (obstacle.suggestedAction === 'login') {
      // è¯·æ±‚ç”¨æˆ·ç™»å½•
      const response = await askUser(INTERACTIONS.loginRequired(url));
      if (response === 'skip') return { success: false, /* ... */ };
      if (response === 'abort') throw new Error('User aborted');
      // ç”¨æˆ·ç™»å½•åé‡è¯•
      return extractWeb(url, strategy);
    }

    if (obstacle.suggestedAction === 'screenshot') {
      // åˆ‡æ¢åˆ°æˆªå›¾æ¨¡å¼
      return extractWebViaScreenshot(url);
    }
  }

  // 4. æ£€æŸ¥å†…å®¹å¤§å°
  if (snapshot.length > SAFETY_LIMITS.url.maxSnapshotChars) {
    // æˆªæ–­å¹¶æ ‡è®°
    const truncated = snapshot.substring(0, SAFETY_LIMITS.url.maxSnapshotChars);
    return {
      success: true,
      source: url,
      type: 'url',
      content: {
        text: truncated + '\n\n[å†…å®¹å·²æˆªæ–­]',
        // ...
      },
      stats: { /* ... */ },
    };
  }

  // 5. æå–å›¾ç‰‡æè¿°ï¼ˆé™åˆ¶æ•°é‡ï¼‰
  const images = await extractPageImages(url, SAFETY_LIMITS.batch.maxImages);

  // 6. è¿”å›ç»“æœ
  return {
    success: true,
    source: url,
    type: 'url',
    content: {
      title: extractTitle(snapshot),
      text: snapshot,
      structure: extractHeadings(snapshot),
      images,
    },
    stats: {
      originalSize: snapshot.length,
      extractedChars: snapshot.length,
      imagesProcessed: images.length,
      processingTimeMs: Date.now() - startTime,
    },
  };
}

// å›¾ç‰‡æå–å™¨
async function extractImage(path: string, strategy: ProcessingStrategy): Promise<ExtractionResult> {
  const startTime = Date.now();
  const originalSize = await getFileSize(path);

  let imagePath = path;

  // 1. å‹ç¼©å¤„ç†ï¼ˆå¦‚éœ€è¦ï¼‰
  if (strategy === 'COMPRESS' || originalSize > SAFETY_LIMITS.image.maxSize) {
    imagePath = await compressImage(path, {
      maxWidth: SAFETY_LIMITS.image.maxWidth,
      maxSize: SAFETY_LIMITS.image.maxSize,
    });
  }

  // 2. éªŒè¯å‹ç¼©åå¤§å°
  const compressedSize = await getFileSize(imagePath);
  if (compressedSize > SAFETY_LIMITS.image.maxSize) {
    // äºŒæ¬¡å‹ç¼©ï¼Œé™ä½åˆ†è¾¨ç‡
    imagePath = await compressImage(path, {
      maxWidth: 640,
      maxSize: 200 * 1024,
    });
  }

  // 3. è¯»å–å¹¶åˆ†æå›¾ç‰‡
  const imageContent = await readFile(imagePath);
  const description = await describeImage(imageContent);

  return {
    success: true,
    source: path,
    type: 'image',
    content: {
      text: formatImageDescription(description),
      images: [description],
    },
    stats: {
      originalSize,
      extractedChars: description.description.length,
      imagesProcessed: 1,
      processingTimeMs: Date.now() - startTime,
    },
  };
}
```

---

### 3.4 ç†è§£ä¸è½¬æ¢å±‚ (Understanding Engine)

#### 3.4.1 èŒè´£

- å°†æå–ç»“æœè½¬æ¢ä¸ºä¸­é—´è¡¨ç¤º (IR)
- è¯†åˆ«å›¾ç‰‡ç±»å‹å¹¶åº”ç”¨ä¸“ç”¨æè¿°ç­–ç•¥
- ç”Ÿæˆç»“æ„åŒ–æ‘˜è¦

#### 3.4.2 ä¸­é—´è¡¨ç¤º (IR) ç»“æ„

```typescript
interface IntermediateRepresentation {
  // å…ƒä¿¡æ¯
  meta: {
    source: string;           // åŸå§‹æ¥æº
    sourceType: 'url' | 'file' | 'directory';
    title: string;
    extractedAt: string;      // ISO æ—¶é—´æˆ³
    totalFiles?: number;      // ç›®å½•æ¨¡å¼ä¸‹çš„æ–‡ä»¶æ•°
  };

  // ç»Ÿè®¡ä¿¡æ¯
  stats: {
    totalChars: number;
    totalImages: number;
    processingTimeMs: number;
    filesProcessed: number;
    filesSkipped: number;
    errors: number;
  };

  // æ–‡æ¡£ç»“æ„ï¼ˆç›®å½•ï¼‰
  structure: Array<{
    level: number;            // å±‚çº§ 1-6
    title: string;
    anchor?: string;          // é”šç‚¹ ID
  }>;

  // å†…å®¹å—
  content: ContentBlock[];

  // èµ„æºæè¿°
  assets: AssetDescription[];
}

type ContentBlock =
  | { type: 'heading'; level: number; text: string }
  | { type: 'paragraph'; text: string }
  | { type: 'list'; ordered: boolean; items: string[] }
  | { type: 'table'; headers: string[]; rows: string[][] }
  | { type: 'code'; language?: string; code: string }
  | { type: 'image_ref'; assetIndex: number }
  | { type: 'file_summary'; path: string; summary: string };

interface AssetDescription {
  type: 'image' | 'diagram' | 'screenshot' | 'chart';
  source: string;
  category: ImageCategory;
  description: string;
  extractedText?: string;
  structure?: any;  // å›¾è¡¨ç‰¹æœ‰ç»“æ„ï¼ˆå¦‚æµç¨‹å›¾èŠ‚ç‚¹ï¼‰
}

type ImageCategory =
  | 'flowchart'     // æµç¨‹å›¾
  | 'architecture'  // æ¶æ„å›¾
  | 'screenshot'    // ç•Œé¢æˆªå›¾
  | 'chart'         // æ•°æ®å›¾è¡¨
  | 'table_image'   // è¡¨æ ¼å›¾ç‰‡
  | 'photo'         // ç…§ç‰‡
  | 'diagram'       // å…¶ä»–å›¾ç¤º
  | 'decorative';   // è£…é¥°å›¾ï¼ˆè·³è¿‡ï¼‰
```

#### 3.4.3 å›¾ç‰‡ç†è§£ç­–ç•¥

```typescript
// å›¾ç‰‡ç±»å‹è¯†åˆ«æç¤ºè¯
const IMAGE_CATEGORY_PROMPT = `
åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œåˆ¤æ–­å…¶ç±»å‹å¹¶æŒ‰å¯¹åº”æ ¼å¼æè¿°ï¼š

ç±»å‹è¯†åˆ«è§„åˆ™ï¼š
- flowchart: åŒ…å«ç®­å¤´è¿æ¥çš„èŠ‚ç‚¹ã€æµç¨‹æ­¥éª¤
- architecture: åˆ†å±‚ç»“æ„ã€æ¨¡å—ç»„ä»¶ã€ç³»ç»Ÿæ¶æ„
- screenshot: UIç•Œé¢ã€åº”ç”¨æˆªå›¾ã€ç½‘é¡µæˆªå›¾
- chart: æŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ç­‰æ•°æ®å¯è§†åŒ–
- table_image: è¡¨æ ¼å½¢å¼çš„æ•°æ®
- photo: è‡ªç„¶ç…§ç‰‡ã€äººç‰©ç…§ç‰‡
- diagram: å…¶ä»–ç¤ºæ„å›¾
- decorative: å›¾æ ‡ã€logoã€è£…é¥°å…ƒç´ ï¼ˆç®€å•æ ‡æ³¨å³å¯ï¼‰
`;

// å„ç±»å‹ä¸“ç”¨æè¿°æ¨¡æ¿
const DESCRIPTION_TEMPLATES = {
  flowchart: `
---
**[å›¾ç‰‡: {title}]**
ç±»å‹: æµç¨‹å›¾
èŠ‚ç‚¹:
{nodes}
æµå‘: {flow_description}
å…³é”®è·¯å¾„: {critical_path}
---`,

  architecture: `
---
**[å›¾ç‰‡: {title}]**
ç±»å‹: æ¶æ„å›¾
å±‚çº§:
{layers}
ç»„ä»¶å…³ç³»: {relationships}
---`,

  screenshot: `
---
**[å›¾ç‰‡: {title}]**
ç±»å‹: ç•Œé¢æˆªå›¾
å¸ƒå±€: {layout}
ä¸»è¦å…ƒç´ : {elements}
æå–æ–‡å­—: {extracted_text}
---`,

  chart: `
---
**[å›¾ç‰‡: {title}]**
ç±»å‹: æ•°æ®å›¾è¡¨
å›¾è¡¨ç±»å‹: {chart_type}
æ•°æ®æ¦‚è¦: {data_summary}
è¶‹åŠ¿/ç»“è®º: {insights}
---`,

  table_image: `
---
**[å›¾ç‰‡: {title}]**
ç±»å‹: è¡¨æ ¼

| {headers} |
|{separators}|
{rows}
---`,

  photo: `
---
**[å›¾ç‰‡: {title}]**
æè¿°: {description}
---`,

  decorative: `[å›¾æ ‡: {brief}]`,
};

// å›¾ç‰‡ç†è§£å‡½æ•°
async function understandImage(
  imageContent: Buffer,
  context?: string  // ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚æ‰€åœ¨ç« èŠ‚ï¼‰
): Promise<AssetDescription> {

  // 1. ç±»å‹è¯†åˆ«
  const category = await classifyImage(imageContent, IMAGE_CATEGORY_PROMPT);

  // 2. è·³è¿‡è£…é¥°å›¾
  if (category === 'decorative') {
    return {
      type: 'image',
      source: '',
      category: 'decorative',
      description: '[è£…é¥°æ€§å›¾ç‰‡ï¼Œå·²è·³è¿‡]',
    };
  }

  // 3. æ ¹æ®ç±»å‹åº”ç”¨ä¸“ç”¨åˆ†æ
  const analysis = await analyzeImageByCategory(imageContent, category, context);

  // 4. æ ¼å¼åŒ–æè¿°
  const description = formatDescription(DESCRIPTION_TEMPLATES[category], analysis);

  return {
    type: 'image',
    source: '',
    category,
    description,
    extractedText: analysis.extractedText,
    structure: analysis.structure,
  };
}
```

#### 3.4.4 æ‘˜è¦ç”Ÿæˆ

```typescript
interface Summary {
  file: string;
  type: string;
  title: string;
  summary: string;           // â‰¤200 å­—
  keyPoints: string[];       // 3-5 ä¸ªè¦ç‚¹
  structure: string[];       // ç« èŠ‚åˆ—è¡¨
  imageCount: number;
  hasCode: boolean;
  hasTables: boolean;
}

const SUMMARY_PROMPT = `
ä¸ºä»¥ä¸‹å†…å®¹ç”Ÿæˆç»“æ„åŒ–æ‘˜è¦ï¼Œä¸¥æ ¼éµå®ˆå­—æ•°é™åˆ¶ï¼š

è¦æ±‚ï¼š
1. summary: æ ¸å¿ƒå†…å®¹æ¦‚è¿°ï¼Œä¸è¶…è¿‡ 200 å­—
2. keyPoints: 3-5 ä¸ªå…³é”®è¦ç‚¹ï¼Œæ¯ä¸ªä¸è¶…è¿‡ 50 å­—
3. structure: åˆ—å‡ºä¸»è¦ç« èŠ‚æ ‡é¢˜

å†…å®¹ï¼š
{content}

è¾“å‡º JSON æ ¼å¼ã€‚
`;

async function generateSummary(result: ExtractionResult): Promise<Summary> {
  // å¦‚æœå†…å®¹è¾ƒçŸ­ï¼Œç›´æ¥ä¿ç•™
  if (result.content.text.length <= SAFETY_LIMITS.output.summaryMaxChars) {
    return {
      file: result.source,
      type: result.type,
      title: result.content.title || basename(result.source),
      summary: result.content.text,
      keyPoints: [],
      structure: result.content.structure || [],
      imageCount: result.content.images?.length || 0,
      hasCode: /```/.test(result.content.text),
      hasTables: /\|.*\|/.test(result.content.text),
    };
  }

  // ä½¿ç”¨ AI ç”Ÿæˆæ‘˜è¦
  const response = await generateWithAI(SUMMARY_PROMPT, {
    content: result.content.text.substring(0, 10000),  // é™åˆ¶è¾“å…¥
  });

  return {
    file: result.source,
    type: result.type,
    ...JSON.parse(response),
    imageCount: result.content.images?.length || 0,
    hasCode: /```/.test(result.content.text),
    hasTables: /\|.*\|/.test(result.content.text),
  };
}
```

---

### 3.5 è¾“å‡ºç”Ÿæˆå±‚ (Output Generator)

#### 3.5.1 èŒè´£

- å°† IR è½¬æ¢ä¸ºæœ€ç»ˆè¾“å‡ºæ ¼å¼
- æ”¯æŒ Markdownã€JSON æ ¼å¼
- å¯é€‰è°ƒç”¨ plugin-dev ç”Ÿæˆ Skill/Plugin

#### 3.5.2 Markdown è¾“å‡º

```typescript
function generateMarkdown(ir: IntermediateRepresentation): string {
  const lines: string[] = [];

  // 1. å…ƒä¿¡æ¯å¤´
  lines.push('---');
  lines.push(`source: ${ir.meta.source}`);
  lines.push(`title: ${ir.meta.title}`);
  lines.push(`extracted_at: ${ir.meta.extractedAt}`);
  if (ir.meta.totalFiles) {
    lines.push(`total_files: ${ir.meta.totalFiles}`);
  }
  lines.push('stats:');
  lines.push(`  chars: ${ir.stats.totalChars}`);
  lines.push(`  images: ${ir.stats.totalImages}`);
  lines.push(`  files_processed: ${ir.stats.filesProcessed}`);
  if (ir.stats.errors > 0) {
    lines.push(`  errors: ${ir.stats.errors}`);
  }
  lines.push('---');
  lines.push('');

  // 2. æ ‡é¢˜
  lines.push(`# ${ir.meta.title}`);
  lines.push('');

  // 3. ç›®å½•ï¼ˆå¦‚æœæœ‰å¤šä¸ªç« èŠ‚ï¼‰
  if (ir.structure.length > 3) {
    lines.push('## ç›®å½•');
    lines.push('');
    for (const item of ir.structure) {
      const indent = '  '.repeat(item.level - 1);
      lines.push(`${indent}- ${item.title}`);
    }
    lines.push('');
  }

  // 4. å†…å®¹
  for (const block of ir.content) {
    lines.push(renderContentBlock(block, ir.assets));
    lines.push('');
  }

  return lines.join('\n');
}

function renderContentBlock(block: ContentBlock, assets: AssetDescription[]): string {
  switch (block.type) {
    case 'heading':
      return '#'.repeat(block.level) + ' ' + block.text;

    case 'paragraph':
      return block.text;

    case 'list':
      return block.items
        .map((item, i) => block.ordered ? `${i + 1}. ${item}` : `- ${item}`)
        .join('\n');

    case 'table':
      const header = '| ' + block.headers.join(' | ') + ' |';
      const separator = '|' + block.headers.map(() => '---').join('|') + '|';
      const rows = block.rows.map(row => '| ' + row.join(' | ') + ' |').join('\n');
      return [header, separator, rows].join('\n');

    case 'code':
      return '```' + (block.language || '') + '\n' + block.code + '\n```';

    case 'image_ref':
      return assets[block.assetIndex]?.description || '[å›¾ç‰‡]';

    case 'file_summary':
      return `### ${block.path}\n\n${block.summary}`;

    default:
      return '';
  }
}
```

#### 3.5.3 JSON è¾“å‡º

```typescript
function generateJSON(ir: IntermediateRepresentation): string {
  return JSON.stringify({
    meta: ir.meta,
    stats: ir.stats,
    structure: ir.structure,
    content: ir.content.map(block => {
      if (block.type === 'image_ref') {
        return {
          type: 'image',
          ...ir.assets[block.assetIndex],
        };
      }
      return block;
    }),
  }, null, 2);
}
```

#### 3.5.4 Skill/Plugin ç”Ÿæˆ

```typescript
async function generateSkill(ir: IntermediateRepresentation): Promise<void> {
  // è°ƒç”¨ plugin-dev çš„ skill-development skill
  await invokeSkill('plugin-dev:skill-development', {
    context: `
åŸºäºä»¥ä¸‹æå–çš„å†…å®¹ï¼Œåˆ›å»ºä¸€ä¸ª Claude Code Skillï¼š

æ¥æºï¼š${ir.meta.source}
æ ‡é¢˜ï¼š${ir.meta.title}

å†…å®¹æ‘˜è¦ï¼š
${ir.content.slice(0, 5).map(b =>
  b.type === 'paragraph' ? b.text.substring(0, 200) : ''
).join('\n')}

ç»“æ„ï¼š
${ir.structure.map(s => '  '.repeat(s.level) + s.title).join('\n')}

è¯·æ ¹æ®å†…å®¹ç‰¹ç‚¹ï¼Œè®¾è®¡åˆé€‚çš„ Skill ç»“æ„ã€‚
`,
  });
}

async function generatePlugin(ir: IntermediateRepresentation): Promise<void> {
  // è°ƒç”¨ plugin-dev çš„ plugin-structure skill
  await invokeSkill('plugin-dev:plugin-structure', {
    context: `
åŸºäºä»¥ä¸‹æå–çš„å†…å®¹ï¼Œåˆ›å»ºä¸€ä¸ª Claude Code Pluginï¼š

æ¥æºï¼š${ir.meta.source}
æ ‡é¢˜ï¼š${ir.meta.title}
æ–‡ä»¶æ•°ï¼š${ir.meta.totalFiles || 1}

å†…å®¹ç»“æ„ï¼š
${ir.structure.map(s => '  '.repeat(s.level) + s.title).join('\n')}

è¯·è®¾è®¡åˆé€‚çš„ Plugin ç»“æ„ï¼ŒåŒ…å«å¿…è¦çš„ commandsã€skillsã€agentsã€‚
`,
  });
}
```

---

## 4. ç”¨æˆ·äº¤äº’æµç¨‹

### 4.1 æ ‡å‡†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ·äº¤äº’æµç¨‹å›¾                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   ç”¨æˆ·: /knowledge-etl:extract <source>                                 â”‚
â”‚                    â”‚                                                     â”‚
â”‚                    â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚   â”‚           è¾“å…¥è§£æ                      â”‚                            â”‚
â”‚   â”‚                                        â”‚                            â”‚
â”‚   â”‚   - è¯†åˆ«ç±»å‹                           â”‚                            â”‚
â”‚   â”‚   - å±•å¼€æ–‡ä»¶åˆ—è¡¨                       â”‚                            â”‚
â”‚   â”‚   - è®¡ç®—æ€»å¤§å°                         â”‚                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                    â”‚                                                     â”‚
â”‚                    â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚   â”‚         é¢„æ£€ & ç”¨æˆ·ç¡®è®¤                 â”‚                            â”‚
â”‚   â”‚                                        â”‚                            â”‚
â”‚   â”‚   æ–‡ä»¶æ•° > 20?  â”€â”€æ˜¯â”€â”€â†’ è¯¢é—®ç”¨æˆ·       â”‚â”€â”€â†’ ç”¨æˆ·é€‰æ‹©               â”‚
â”‚   â”‚   æ€»å¤§å° > 10MB? â”€â”€æ˜¯â”€â”€â†’ è¯¢é—®ç”¨æˆ·      â”‚    - å…¨éƒ¨å¤„ç†             â”‚
â”‚   â”‚                                        â”‚    - éƒ¨åˆ†å¤„ç†             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    - å–æ¶ˆ                 â”‚
â”‚                    â”‚                                                     â”‚
â”‚                    â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚   â”‚           æ˜¾ç¤ºå¤„ç†è®¡åˆ’                  â”‚                            â”‚
â”‚   â”‚                                        â”‚                            â”‚
â”‚   â”‚   ã€Œå‘ç° N ä¸ªæ–‡ä»¶ï¼Œå°†åˆ† M æ‰¹å¤„ç†       â”‚                            â”‚
â”‚   â”‚     é¢„è®¡è¾“å‡º X å­—ç¬¦çš„æ–‡æ¡£ã€            â”‚                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                    â”‚                                                     â”‚
â”‚                    â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚   â”‚         æ‰¹æ¬¡å¤„ç†å¾ªç¯                    â”‚                            â”‚
â”‚   â”‚                                        â”‚                            â”‚
â”‚   â”‚   for batch in batches:                â”‚                            â”‚
â”‚   â”‚     â”‚                                  â”‚                            â”‚
â”‚   â”‚     â”œâ”€â†’ å¤„ç†æ–‡ä»¶/URL                   â”‚                            â”‚
â”‚   â”‚     â”‚     â”‚                            â”‚                            â”‚
â”‚   â”‚     â”‚     â”œâ”€â†’ é‡åˆ°éšœç¢?                â”‚                            â”‚
â”‚   â”‚     â”‚     â”‚     â”‚                      â”‚                            â”‚
â”‚   â”‚     â”‚     â”‚     â”œâ”€â†’ ç™»å½•éœ€æ±‚ â”€â”€â†’ ç­‰å¾…ç”¨æˆ·ç™»å½•                      â”‚
â”‚   â”‚     â”‚     â”‚     â”œâ”€â†’ åçˆ¬æ£€æµ‹ â”€â”€â†’ è¯¢é—®æ˜¯å¦æˆªå›¾                      â”‚
â”‚   â”‚     â”‚     â”‚     â””â”€â†’ è¶…æ—¶å¤±è´¥ â”€â”€â†’ è¯¢é—®æ˜¯å¦é‡è¯•                      â”‚
â”‚   â”‚     â”‚     â”‚                            â”‚                            â”‚
â”‚   â”‚     â”‚     â””â”€â†’ æå–æˆåŠŸ â”€â”€â†’ ç”Ÿæˆæ‘˜è¦   â”‚                            â”‚
â”‚   â”‚     â”‚                                  â”‚                            â”‚
â”‚   â”‚     â””â”€â†’ æ˜¾ç¤ºæ‰¹æ¬¡è¿›åº¦                   â”‚                            â”‚
â”‚   â”‚         ã€Œå·²å®Œæˆ 3/10 æ‰¹æ¬¡ã€           â”‚                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                    â”‚                                                     â”‚
â”‚                    â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚   â”‚           æ±‡æ€» & è¾“å‡ºé€‰æ‹©               â”‚                            â”‚
â”‚   â”‚                                        â”‚                            â”‚
â”‚   â”‚   ã€Œæå–å®Œæˆï¼å…±å¤„ç† N ä¸ªæ–‡ä»¶          â”‚                            â”‚
â”‚   â”‚     è¯·é€‰æ‹©è¾“å‡ºæ ¼å¼ï¼š                   â”‚                            â”‚
â”‚   â”‚                                        â”‚                            â”‚
â”‚   â”‚     [åŸå§‹æ–‡æ¡£] [ç”Ÿæˆ Skill] [ç”Ÿæˆ Plugin]ã€                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                    â”‚                                                     â”‚
â”‚                    â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚   â”‚           ç”Ÿæˆæœ€ç»ˆè¾“å‡º                  â”‚                            â”‚
â”‚   â”‚                                        â”‚                            â”‚
â”‚   â”‚   ç”¨æˆ·é€‰æ‹© â”€â”€â†’ ç”Ÿæˆå¯¹åº”æ ¼å¼            â”‚                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 äº¤äº’æ¶ˆæ¯æ¨¡æ¿

```typescript
const MESSAGES = {
  // å¼€å§‹æå–
  start: (source: string, type: string) =>
    `æ­£åœ¨åˆ†æ ${type} æ¥æº: ${source}`,

  // é¢„æ£€ç»“æœ
  precheck: (stats: { files: number; size: string; batches: number }) =>
    `å‘ç° ${stats.files} ä¸ªæ–‡ä»¶ï¼ˆçº¦ ${stats.size}ï¼‰ï¼Œå°†åˆ† ${stats.batches} æ‰¹å¤„ç†`,

  // æ‰¹æ¬¡è¿›åº¦
  batchProgress: (current: number, total: number, file: string) =>
    `[${current}/${total}] æ­£åœ¨å¤„ç†: ${file}`,

  // éšœç¢æç¤º
  obstacle: {
    login: (url: string) =>
      `é¡µé¢éœ€è¦ç™»å½•: ${url}\nè¯·åœ¨å¼¹å‡ºçš„æµè§ˆå™¨ä¸­å®Œæˆç™»å½•`,

    antiScrape: (url: string) =>
      `é¡µé¢æ— æ³•ç›´æ¥æå–: ${url}\nå»ºè®®ä½¿ç”¨æˆªå›¾æ¨¡å¼`,

    timeout: (url: string) =>
      `è¯·æ±‚è¶…æ—¶: ${url}`,
  },

  // å®Œæˆæç¤º
  complete: (stats: { files: number; chars: number; time: number }) =>
    `æå–å®Œæˆï¼\n` +
    `- å¤„ç†æ–‡ä»¶: ${stats.files} ä¸ª\n` +
    `- æå–å†…å®¹: ${stats.chars} å­—ç¬¦\n` +
    `- ç”¨æ—¶: ${stats.time} ç§’`,

  // é”™è¯¯æç¤º
  error: (message: string) =>
    `æå–å¤±è´¥: ${message}`,
};
```

---

## 5. æ–‡ä»¶ç»“æ„

```
platforms/claude/knowledge-etl/
â”œâ”€â”€ adskill.yaml                    # æ’ä»¶é…ç½®
â”œâ”€â”€ .mcp.json                       # MCP æœåŠ¡é…ç½®ï¼ˆPlaywrightï¼‰
â”œâ”€â”€ DESIGN.md                       # æœ¬è®¾è®¡æ–‡æ¡£
â”œâ”€â”€ README.md                       # ç”¨æˆ·æ–‡æ¡£
â”‚
â”œâ”€â”€ commands/
â”‚   â””â”€â”€ extract.md                  # ä¸»å‘½ä»¤
â”‚
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ extractor.md                # æå–æ‰§è¡Œ Agentï¼ˆéš”ç¦»ä¸Šä¸‹æ–‡ï¼‰
â”‚   â””â”€â”€ summarizer.md               # æ‘˜è¦ç”Ÿæˆ Agentï¼ˆå¯é€‰ï¼‰
â”‚
â”œâ”€â”€ skills/
â”‚   â”œâ”€â”€ extract/
â”‚   â”‚   â””â”€â”€ SKILL.md                # æå–æŠ€èƒ½è¯´æ˜
â”‚   â””â”€â”€ plugin-troubleshooting/
â”‚       â””â”€â”€ SKILL.md                # é—®é¢˜æ’æŸ¥æŠ€èƒ½
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ compress-image.sh           # å›¾ç‰‡å‹ç¼©è„šæœ¬
â”‚   â””â”€â”€ compress-image.mjs          # å‹ç¼©å®ç°
â”‚
â””â”€â”€ .claude-plugin/
    â””â”€â”€ plugin.json                 # æ’ä»¶æ¸…å•
```

---

## 6. é…ç½®é¡¹

```yaml
# knowledge-etl.config.yamlï¼ˆæœªæ¥æ”¯æŒï¼‰

# å®‰å…¨é™åˆ¶
limits:
  image:
    max_size: 300KB
    max_width: 800
  pdf:
    max_pages: 20
  text:
    max_chars: 50000
  batch:
    max_files: 5
    max_size: 1MB

# ç›®å½•æ‰«æ
scanner:
  exclude:
    - node_modules
    - .git
    - "*.lock"
  include:
    - "*.md"
    - "*.pdf"
    - "*.png"
    - "*.jpg"

# è¾“å‡ºé…ç½®
output:
  default_format: markdown
  summary_max_chars: 500
  include_stats: true

# ç¼“å­˜é…ç½®ï¼ˆæœªæ¥æ”¯æŒï¼‰
cache:
  enabled: false
  ttl: 3600
  directory: .knowledge-etl-cache
```

---

## 7. å®ç°è·¯çº¿å›¾

### Phase 1: æ ¸å¿ƒèƒ½åŠ›ï¼ˆå½“å‰ï¼‰

- [x] åŸºç¡€æå– Agent
- [x] å›¾ç‰‡å‹ç¼©è„šæœ¬
- [ ] å®‰å…¨æ§åˆ¶å±‚å®Œå–„
- [ ] ç”¨æˆ·äº¤äº’æµç¨‹
- [ ] æ‰¹æ¬¡å¤„ç†æœºåˆ¶

### Phase 2: å¢å¼ºåŠŸèƒ½

- [ ] ç›®å½•æ‰«æä¸å¤šæ–‡ä»¶å¤„ç†
- [ ] å›¾ç‰‡ç±»å‹è¯†åˆ«ä¸ä¸“ç”¨æè¿°
- [ ] JSON è¾“å‡ºæ ¼å¼
- [ ] éšœç¢æ£€æµ‹ä¸é™çº§

### Phase 3: é›†æˆä¸æ‰©å±•

- [ ] Skill/Plugin ç”Ÿæˆé›†æˆ
- [ ] ç¼“å­˜æœºåˆ¶
- [ ] å¢é‡å¤„ç†
- [ ] è‡ªå®šä¹‰æå–å™¨æ‰©å±•

---

## 8. é™„å½•

### 8.1 é”™è¯¯ç å®šä¹‰

| é”™è¯¯ç  | å«ä¹‰ | å¤„ç†æ–¹å¼ |
|--------|------|----------|
| E001 | è¾“å…¥æºä¸å­˜åœ¨ | æç¤ºç”¨æˆ·æ£€æŸ¥è·¯å¾„ |
| E002 | æ— è®¿é—®æƒé™ | æç¤ºç”¨æˆ·æ£€æŸ¥æƒé™ |
| E003 | ç½‘ç»œè¶…æ—¶ | è¯¢é—®æ˜¯å¦é‡è¯• |
| E004 | éœ€è¦ç™»å½• | ç­‰å¾…ç”¨æˆ·ç™»å½• |
| E005 | åçˆ¬æ‹¦æˆª | åˆ‡æ¢æˆªå›¾æ¨¡å¼ |
| E006 | æ–‡ä»¶è¿‡å¤§ | å‹ç¼©æˆ–æ‘˜è¦æ¨¡å¼ |
| E007 | ä¸æ”¯æŒçš„æ ¼å¼ | è·³è¿‡å¹¶è®°å½• |
| E008 | å¤„ç†è¶…é™ | åˆ†æ‰¹æˆ–æ‘˜è¦æ¨¡å¼ |

### 8.2 æ€§èƒ½åŸºå‡†

| åœºæ™¯ | é¢„æœŸæ—¶é—´ | è¾“å‡ºå¤§å° |
|------|----------|----------|
| å•ä¸ªç½‘é¡µï¼ˆæ— å›¾ï¼‰ | 5-10s | 2-10KB |
| å•ä¸ªç½‘é¡µï¼ˆ5å¼ å›¾ï¼‰ | 15-30s | 5-15KB |
| å•å¼ å¤§å›¾ç‰‡ | 5-10s | 0.5-1KB |
| 10 é¡µ PDF | 20-40s | 10-20KB |
| 20 ä¸ªæ–‡ä»¶ç›®å½• | 2-5min | 20-50KB |

### 8.3 æœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| IR | Intermediate Representationï¼Œä¸­é—´è¡¨ç¤º |
| ETL | Extract-Transform-Loadï¼Œæå–-è½¬æ¢-åŠ è½½ |
| éšœç¢ | é˜»æ­¢æ­£å¸¸æå–çš„å› ç´ ï¼ˆç™»å½•ã€åçˆ¬ç­‰ï¼‰ |
| æ‘˜è¦æ¨¡å¼ | åªç”Ÿæˆå†…å®¹æ‘˜è¦ï¼Œä¸ä¿ç•™å…¨æ–‡ |
| æ‰¹æ¬¡ | ä¸€ç»„åŒæ—¶å¤„ç†çš„ä»»åŠ¡ |
